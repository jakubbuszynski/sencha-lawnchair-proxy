var Lawnchair=function(){if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(arguments.length<=2&&arguments.length>0)var d=typeof arguments[0]==="function"?arguments[0]:arguments[1],a=typeof arguments[0]==="function"?{}:arguments[0];else throw"Incorrect # of ctor args!";if(typeof d!=="function")throw"No callback was provided";this.record=a.record||"record";this.name=a.name||"records";var c;if(a.adapter){c=Lawnchair.adapters[Lawnchair.adapters.indexOf(a.adapter)];c=c.valid()?
c:undefined}else for(var b=0,e=Lawnchair.adapters.length;b<e;b++)if(c=Lawnchair.adapters[b].valid()?Lawnchair.adapters[b]:undefined)break;if(!c)throw"No valid adapter.";for(var f in c)this[f]=c[f];b=0;for(e=Lawnchair.plugins.length;b<e;b++)Lawnchair.plugins[b].call(this);this.init(a,d)};Lawnchair.adapters=[];
Lawnchair.adapter=function(d,a){a.adapter=d;var c="adapter valid init keys save batch get exists all remove nuke".split(" "),b;for(b in a)if(c.indexOf(b)===-1)throw"Invalid adapter! Nonstandard method: "+b;Lawnchair.adapters.push(a)};Lawnchair.plugins=[];Lawnchair.plugin=function(d){for(var a in d)a==="init"?Lawnchair.plugins.push(d[a]):this.prototype[a]=d[a]};
Lawnchair.prototype={isArray:Array.isArray||function(d){return Object.prototype.toString.call(d)==="[object Array]"},lambda:function(d){return this.fn(this.record,d)},fn:function(d,a){return typeof a=="string"?new Function(d,a):a},uuid:function(){var d=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d()},each:function(d){var a=this.lambda(d);if(this.__results){d=0;for(var c=this.__results.length;d<c;d++)a.call(this,this.__results[d],
d)}else this.all(function(b){for(var e=0,f=b.length;e<f;e++)a.call(this,b[e],e)});return this}};
Lawnchair.adapter("webkit-sqlite",function(){var d=function(a,c){console.log("error in sqlite adaptor!",a,c)};if(!Function.prototype.bind)Function.prototype.bind=function(a){var c=[].slice,b=c.call(arguments,1),e=this,f=function(){},j=function(){return e.apply(this instanceof f?this:a||{},b.concat(c.call(arguments)))};f.prototype=e.prototype;j.prototype=new f;return j};return{valid:function(){return!!window.openDatabase},init:function(a,c){var b="CREATE TABLE IF NOT EXISTS "+this.name+" (id NVARCHAR(32) UNIQUE PRIMARY KEY, value TEXT, timestamp REAL)",
e=this.fn(this.name,c).bind(this);this.db=openDatabase(this.name,"1.0.0",this.name,65536);this.db.transaction(function(f){f.executeSql(b,[],e,d)})},keys:function(a){var c=this.lambda(a),b=this,e="SELECT id FROM "+this.name+" ORDER BY timestamp DESC";this.db.transaction(function(f){f.executeSql(e,[],function(j,g){if(g.rows.length==0)c.call(b,[]);else{for(var h=[],i=0,k=g.rows.length;i<k;i++)h.push(g.rows.item(i).id);c.call(b,h)}},d)});return this},save:function(a,c){var b=this,e=a.key||b.uuid(),f=
"INSERT INTO "+this.name+" (value, timestamp, id) VALUES (?,?,?)",j="UPDATE "+this.name+" SET value=?, timestamp=? WHERE id=?",g=function(){if(c){a.key=e;b.lambda(c).call(b,a)}},h=[new Date,e];b.exists(a.key,function(i){b.db.transaction(function(k){var l=function(m){delete m.key;h.unshift(JSON.stringify(m));k.executeSql(j,h,g,d)};if(i)l(a);else{h.unshift(JSON.stringify(a));k.executeSql(f,h,g,d)}})});return this},batch:function(a,c){for(var b=[],e=false,f=this,j=function(k){b.push(k);e=b.length===
a.length},g=setInterval(function(){if(e){c&&f.lambda(c).call(f,b);clearInterval(g)}},200),h=0,i=a.length;h<i;h++)this.save(a[h],j);return this},get:function(a,c){var b=this,e="";e=this.isArray(a)?"SELECT id, value FROM "+this.name+" WHERE id IN ('"+a.join("','")+"')":"SELECT id, value FROM "+this.name+" WHERE id = '"+a+"'";var f=function(j,g){var h=null,i=[];if(g.rows.length)for(var k=0,l=g.rows.length;k<l;k++){h=JSON.parse(g.rows.item(k).value);h.key=g.rows.item(k).id;i.push(h)}b.isArray(a)||(i=
i.length?i[0]:null);c&&b.lambda(c).call(b,i)};this.db.transaction(function(j){j.executeSql(e,[],f,d)});return this},exists:function(a,c){var b="SELECT * FROM "+this.name+" WHERE id = ?",e=this,f=function(j,g){c&&e.fn("exists",c).call(e,g.rows.length>0)};this.db.transaction(function(j){j.executeSql(b,[a],f,d)});return this},all:function(a){var c=this,b="SELECT * FROM "+this.name,e=[],f=this.fn(this.name,a)||undefined,j=function(g,h){if(h.rows.length!=0)for(var i=0,k=h.rows.length;i<k;i++){var l=JSON.parse(h.rows.item(i).value);
l.key=h.rows.item(i).id;e.push(l)}f&&f.call(c,e)};this.db.transaction(function(g){g.executeSql(b,[],j,d)});return this},remove:function(a,c){var b=this,e=typeof a==="string"?a:a.key,f="DELETE FROM "+this.name+" WHERE id = ?",j=function(){c&&b.lambda(c).call(b)};this.db.transaction(function(g){g.executeSql(f,[e],j,d)});return this},nuke:function(a){var c="DELETE FROM "+this.name,b=this,e=a?function(){b.lambda(a).call(b)}:function(){};this.db.transaction(function(f){f.executeSql(c,[],e,d)});return this}}}());
